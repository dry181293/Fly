<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É—Ö–∞ PRO ‚Äî –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π –ò–ò</title>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --primary: #9d4edd; --error: #ff4d4d; --success: #00f5d4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 450px; padding: 15px; box-sizing: border-box; }
        .card { background: var(--card); border-radius: 25px; padding: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.7); text-align: center; border: 1px solid #333; }
        .grid { display: grid; gap: 8px; margin: 20px auto; background: #222; padding: 10px; border-radius: 15px; width: fit-content; }
        .cell { width: 55px; height: 55px; background: #111; border-radius: 8px; border: 1px solid #333; }
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
        .btn { border: none; border-radius: 18px; padding: 20px; font-size: 20px; font-weight: bold; cursor: pointer; color: white; transition: 0.15s; -webkit-tap-highlight-color: transparent; }
        .btn-dir { background: #3c096c; box-shadow: 0 4px 0 #240046; }
        .btn-dir:active { background: var(--primary); transform: translateY(3px); box-shadow: none; }
        .btn-out { grid-column: span 3; background: var(--error); padding: 25px; font-size: 22px; margin-top: 10px; box-shadow: 0 4px 0 #900; }
        .status { height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: bold; color: var(--success); }
        .setup-row { margin-bottom: 15px; text-align: left; }
        select, input { width: 100%; padding: 12px; border-radius: 10px; background: #222; color: white; border: 1px solid #444; font-size: 16px; margin-top: 5px; }
        .history { background: #000; padding: 12px; border-radius: 12px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #666; text-align: left; margin-top: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <h2 style="color: var(--primary)">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ "–ú—É—Ö–∞"</h2>
        <div class="setup-row">–¶–≤–µ—Ç: 
            <select id="flyColor">
                <option value="–ö—Ä–∞—Å–Ω–∞—è">–ö—Ä–∞—Å–Ω–∞—è üî¥</option>
                <option value="–ó–µ–ª–µ–Ω–∞—è">–ó–µ–ª–µ–Ω–∞—è üü¢</option>
                <option value="–ñ–µ–ª—Ç–∞—è">–ñ–µ–ª—Ç–∞—è üü°</option>
            </select>
        </div>
        <div class="setup-row">–ü–æ–ª–µ: <input type="number" id="size" value="3" min="3" max="5"></div>
        <div class="setup-row">–°–ª–æ–∂–Ω–æ—Å—Ç—å:
            <select id="diff">
                <option value="easy">–ù–æ–≤–∏—á–æ–∫ (–ú–µ–¥–ª–µ–Ω–Ω–æ)</option>
                <option value="med" selected>–ü–∏–ª–æ—Ç (–°—Ä–µ–¥–Ω–µ)</option>
                <option value="hard">–ê—Å (–ë—ã—Å—Ç—Ä–æ)</option>
            </select>
        </div>
        <button onclick="startGame()" class="btn" style="background: var(--success); width: 100%; color: #000;">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
    </div>

    <div id="game" class="card hidden">
        <div class="status" id="status-main">–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è...</div>
        <div id="grid" class="grid"></div>
        <div class="controls">
            <div></div><button class="btn btn-dir" onclick="handleMove('–≤–≤–µ—Ä—Ö')">‚Üë</button><div></div>
            <button class="btn btn-dir" onclick="handleMove('–≤–ª–µ–≤–æ')">‚Üê</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–Ω–∏–∑')">‚Üì</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–ø—Ä–∞–≤–æ')">‚Üí</button>
            <button class="btn btn-out" onclick="playerClaimOut()">–ú–£–•–ê –í–´–õ–ï–¢–ï–õ–ê!</button>
        </div>
        <div id="log" class="history"></div>
        <button onclick="location.reload()" style="margin-top: 20px; background: none; border: 1px solid #444; color: #666; padding: 10px; border-radius: 10px; width: 100%;">–°–±—Ä–æ—Å</button>
    </div>
</div>

<script>
    let config = { size: 3, color: '', diff: '' };
    let fly = { x: 0, y: 0, out: false };
    let lastDir = null;
    let isAiTurn = false;
    let gameOver = false;
    let aiWaitTimeout;

    const dirs = { '–≤–≤–µ—Ä—Ö': {x: 0, y: -1}, '–≤–Ω–∏–∑': {x: 0, y: 1}, '–≤–ª–µ–≤–æ': {x: -1, y: 0}, '–≤–ø—Ä–∞–≤–æ': {x: 1, y: 0} };
    const opposites = { '–≤–≤–µ—Ä—Ö': '–≤–Ω–∏–∑', '–≤–Ω–∏–∑': '–≤–≤–µ—Ä—Ö', '–≤–ª–µ–≤–æ': '–≤–ø—Ä–∞–≤–æ', '–≤–ø—Ä–∞–≤–æ': '–≤–ª–µ–≤–æ' };

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ru-RU';
        window.speechSynthesis.speak(msg);
    }

    function startGame() {
        config.size = parseInt(document.getElementById('size').value);
        config.color = document.getElementById('flyColor').value;
        config.diff = document.getElementById('diff').value;

        fly.x = Math.floor(config.size / 2);
        fly.y = Math.floor(config.size / 2);

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');

        const grid = document.getElementById('grid');
        grid.style.gridTemplateColumns = `repeat(${config.size}, 1fr)`;
        grid.innerHTML = '';
        for(let i=0; i < config.size * config.size; i++) grid.innerHTML += `<div class="cell"></div>`;

        const firstDir = Object.keys(dirs)[Math.floor(Math.random() * 4)];
        const startText = `${config.color} –º—É—Ö–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ, ${config.color} –º—É—Ö–∞ ${firstDir}`;
        
        updateStatus(startText);
        speak(startText);
        moveLogic(firstDir, '–ò–ò');
    }

    function handleMove(dir) {
        if (gameOver || isAiTurn) return;

        // –ü–†–û–í–ï–†–ö–ê –ù–ê –û–ë–†–ê–¢–ù–´–ô –•–û–î
        if (lastDir && dir === opposites[lastDir]) {
            speak("–û—à–∏–±–∫–∞! –û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥ –∑–∞–ø—Ä–µ—â–µ–Ω.");
            endGame("–ü–†–û–ò–ì–†–´–®! –¢—ã —Å–¥–µ–ª–∞–ª –æ–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥. –≠—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.");
            return;
        }

        moveLogic(dir, '–¢—ã');
        updateStatus(`–¢—ã: ${dir.toUpperCase()}`);
        
        if (fly.out) {
            // –ò–ò –∑–∞–º–æ–ª–∫–∞–µ—Ç –∏ –∂–¥–µ—Ç, –Ω–∞–∂–º–µ—à—å –ª–∏ —Ç—ã –∫–Ω–æ–ø–∫—É
            startAiWaitingTimer();
        } else {
            isAiTurn = true;
            let delay = config.diff === 'easy' ? 2000 : (config.diff === 'med' ? 1200 : 700);
            setTimeout(aiMove, delay);
        }
    }

    function aiMove() {
        if (gameOver || fly.out) return;
        
        let allowedKeys = Object.keys(dirs).filter(k => k !== opposites[lastDir]);
        let move = allowedKeys[Math.floor(Math.random() * allowedKeys.length)];

        speak(move);
        updateStatus(`–ò–ò: ${move.toUpperCase()}`);
        moveLogic(move, '–ò–ò');
        isAiTurn = false;

        if (fly.out) {
            startAiWaitingTimer();
        }
    }

    function startAiWaitingTimer() {
        // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 3.5 —Å–µ–∫—É–Ω–¥—ã –∏–≥—Ä–æ–∫ –Ω–µ –Ω–∞–∂–∞–ª "–í—ã–ª–µ—Ç–µ–ª–∞", –ò–ò –æ–±—ä—è–≤–ª—è–µ—Ç –ø–æ–±–µ–¥—É
        aiWaitTimeout = setTimeout(() => {
            if (!gameOver) {
                speak("–•–∞-—Ö–∞! –ú—É—Ö–∞ —É–∂–µ —É–ª–µ—Ç–µ–ª–∞, –∞ —Ç—ã –∏ –Ω–µ –∑–∞–º–µ—Ç–∏–ª! –Ø –ø–æ–±–µ–¥–∏–ª.");
                endGame("–ò–ò –ü–û–ë–ï–î–ò–õ! –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –º–æ–º–µ–Ω—Ç –≤—ã–ª–µ—Ç–∞ –º—É—Ö–∏.");
            }
        }, 3500);
    }

    function moveLogic(dir, player) {
        fly.x += dirs[dir].x;
        fly.y += dirs[dir].y;
        lastDir = dir;
        const logEntry = `<div>${player}: ${dir}</div>`;
        document.getElementById('log').innerHTML = logEntry + document.getElementById('log').innerHTML;
        
        if (fly.x < 0 || fly.x >= config.size || fly.y < 0 || fly.y >= config.size) {
            fly.out = true;
        }
    }

    function playerClaimOut() {
        if (gameOver) return;
        clearTimeout(aiWaitTimeout);
        
        if (fly.out) {
            speak("–í–µ—Ä–Ω–æ! –¢—ã –ø–æ–±–µ–¥–∏–ª, –º—É—Ö–∞ –≤—ã–ª–µ—Ç–µ–ª–∞.");
            endGame("–ü–û–ë–ï–î–ê! –¢—ã –≤–æ–≤—Ä–µ–º—è –∑–∞–º–µ—Ç–∏–ª –≤—ã–ª–µ—Ç.");
        } else {
            speak("–ù–µ—Ç! –ú—É—Ö–∞ –µ—â–µ –Ω–∞ –ø–æ–ª–µ. –¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª.");
            endGame("–ü–†–û–ò–ì–†–´–®! –¢—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É, –∫–æ–≥–¥–∞ –º—É—Ö–∞ –±—ã–ª–∞ –µ—â–µ –≤ –ø–æ–ª–µ.");
        }
    }

    function updateStatus(txt) {
        document.getElementById('status-main').innerText = txt;
    }

    function endGame(msg) {
        gameOver = true;
        setTimeout(() => {
            alert(msg);
            location.reload();
        }, 500);
    }
</script>
</body>
</html>