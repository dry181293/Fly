<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É—Ö–∞ PRO: Redesign</title>
    <style>
        :root { --bg: #0b0e14; --panel: rgba(23, 28, 36, 0.8); --primary: #7928ca; --accent: #ff0080; --succ: #00dfd8; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: radial-gradient(circle at top, #1a1f2c, #0b0e14); color: white; margin: 0; min-height: 100vh; display: flex; justify-content: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 420px; padding: 15px; box-sizing: border-box; }
        
        .card { background: var(--panel); backdrop-filter: blur(10px); border-radius: 24px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; }
        
        .fly-emoji { font-size: 2rem; margin-bottom: 10px; display: block; animation: hover 2s ease-in-out infinite; }
        @keyframes hover { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .status { min-height: 80px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 700; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        .grid { display: grid; gap: 6px; margin: 15px auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); transition: 0.4s; }
        .grid.hidden-grid { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .cell { width: 55px; height: 55px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }

        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
        .btn { border: none; border-radius: 16px; cursor: pointer; color: white; transition: 0.2s; font-weight: bold; }
        .btn-dir { background: linear-gradient(145deg, #2c3344, #1a1f2c); border: 1px solid rgba(255,255,255,0.1); height: 65px; font-size: 1.5rem; }
        .btn-dir:active { transform: scale(0.9); background: var(--primary); }
        
        .btn-out { grid-column: span 3; background: linear-gradient(90deg, #ff0080, #7928ca); padding: 20px; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(255,0,128,0.3); }

        .history { background: rgba(0,0,0,0.4); padding: 12px; border-radius: 16px; height: 100px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; color: #aaa; text-align: left; border: 1px solid rgba(255,255,255,0.05); }
        
        .setup-row { margin-bottom: 15px; text-align: left; }
        select, input { width: 100%; padding: 14px; border-radius: 12px; background: #0b0e14; color: white; border: 1px solid #30363d; font-size: 16px; margin-top: 5px; }
        
        .toggle-view { background: none; border: 1px solid var(--primary); color: var(--primary); padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-bottom: 10px; transition: 0.3s; }
        .toggle-view:hover { background: var(--primary); color: white; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <span class="fly-emoji">ü™∞</span>
        <h2 style="margin: 0 0 20px 0; background: linear-gradient(to right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">–ú–£–•–ê PRO</h2>
        
        <div class="setup-row">
            –ú—É—Ö –Ω–∞ –ø–æ–ª–µ:
            <select id="flyCount">
                <option value="1">1 –ú—É—Ö–∞ (–ö—Ä–∞—Å–Ω–∞—è üî¥)</option>
                <option value="2">2 –ú—É—Ö–∏ (–ö—Ä–∞—Å–Ω–∞—è üî¥, –ó–µ–ª–µ–Ω–∞—è üü¢)</option>
            </select>
        </div>
        
        <div class="setup-row">
            –†–∞–∑–º–µ—Ä –ø–æ–ª—è: <input type="number" id="size" value="3" min="3" max="5">
        </div>

        <button onclick="startGame()" class="btn btn-out" style="margin-top: 20px;">–í–∑–ª–µ—Ç–∞–µ–º!</button>
    </div>

    <div id="game" class="card hidden">
        <button id="toggleGrid" class="toggle-view" onclick="toggleGrid()">üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ</button>
        <div id="status" class="status"></div>
        <div id="grid" class="grid"></div>
        
        <div class="controls">
            <div></div><button class="btn btn-dir" onclick="handleMove('–≤–≤–µ—Ä—Ö')">‚Üë</button><div></div>
            <button class="btn btn-dir" onclick="handleMove('–≤–ª–µ–≤–æ')">‚Üê</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–Ω–∏–∑')">‚Üì</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–ø—Ä–∞–≤–æ')">‚Üí</button>
            <button class="btn btn-out" onclick="playerClaimOut()">–ú–£–•–ê –í–´–õ–ï–¢–ï–õ–ê!</button>
        </div>
        <div id="log" class="history"></div>
        <button onclick="location.reload()" style="margin-top: 15px; background: none; border: none; color: #555; font-size: 13px;">–°–±—Ä–æ—Å –∏–≥—Ä—ã</button>
    </div>
</div>

<script>
    let cfg = { size: 3, count: 1 };
    let flies = [];
    let activeFlyIdx = 0;
    let turnCount = 0;
    let gameOver = false;
    let aiTimeout;

    const dirs = { '–≤–≤–µ—Ä—Ö': {x: 0, y: -1}, '–≤–Ω–∏–∑': {x: 0, y: 1}, '–≤–ª–µ–≤–æ': {x: -1, y: 0}, '–≤–ø—Ä–∞–≤–æ': {x: 1, y: 0} };
    const opposites = { '–≤–≤–µ—Ä—Ö': '–≤–Ω–∏–∑', '–≤–Ω–∏–∑': '–≤–≤–µ—Ä—Ö', '–≤–ª–µ–≤–æ': '–≤–ø—Ä–∞–≤–æ', '–≤–ø—Ä–∞–≤–æ': '–≤–ª–µ–≤–æ' };
    const flyData = [
        { name: '–ö—Ä–∞—Å–Ω–∞—è –º—É—Ö–∞', icon: 'üî¥' },
        { name: '–ó–µ–ª–µ–Ω–∞—è –º—É—Ö–∞', icon: 'üü¢' }
    ];

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ru-RU';
        window.speechSynthesis.speak(msg);
    }

    function toggleGrid() {
        const g = document.getElementById('grid');
        g.classList.toggle('hidden-grid');
        document.getElementById('toggleGrid').innerText = g.classList.contains('hidden-grid') ? "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ" : "üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ";
    }

    function startGame() {
        cfg.size = parseInt(document.getElementById('size').value);
        cfg.count = parseInt(document.getElementById('flyCount').value);
        
        for(let i=0; i<cfg.count; i++) {
            flies.push({ 
                x: Math.floor(cfg.size/2), 
                y: Math.floor(cfg.size/2), 
                name: flyData[i].name, 
                icon: flyData[i].icon,
                out: false, 
                lastDir: null 
            });
        }

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');

        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(${cfg.size}, 1fr)`;
        for(let i=0; i<cfg.size*cfg.size; i++) g.innerHTML += `<div class="cell"></div>`;

        // –ü–ï–†–í–´–ô –•–û–î (—Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞)
        const f = flies[0];
        const initialDir = Object.keys(dirs)[Math.floor(Math.random()*4)];
        const startPhrase = `${f.name} –≤ —Ü–µ–Ω—Ç—Ä–µ ‚Äî ${f.name} ${initialDir}`;
        
        updateStatus(startPhrase);
        speak(startPhrase);
        moveLogic(f, initialDir, '–ò–ò');
    }

    function handleMove(d) {
        if(gameOver) return;
        let f = flies[activeFlyIdx];
        
        if(f.lastDir && d === opposites[f.lastDir]) {
            speak("–û—à–∏–±–∫–∞! –ù–∞–∑–∞–¥ –Ω–µ–ª—å–∑—è.");
            return endGame("–û—à–∏–±–∫–∞! –ù–∞–∑–∞–¥ —Ö–æ–¥–∏—Ç—å –Ω–µ–ª—å–∑—è.");
        }

        const moveText = `${f.name} ${d}`;
        updateStatus(`–¢—ã: ${moveText.toUpperCase()}`);
        moveLogic(f, d, '–¢—ã');
        
        if(f.out) {
            aiTimeout = setTimeout(() => endGame(`–ò–ò –ó–ê–ú–ï–¢–ò–õ –í–´–õ–ï–¢! ${f.name} —É–ª–µ—Ç–µ–ª–∞.`), 3500);
        } else {
            activeFlyIdx = (activeFlyIdx + 1) % cfg.count;
            turnCount++;
            setTimeout(aiMove, 1200);
        }
    }

    function aiMove() {
        if(gameOver || flies.some(fl => fl.out)) return;
        let f = flies[activeFlyIdx];
        
        let keys = Object.keys(dirs).filter(k => k !== opposites[f.lastDir]);
        let safeKeys = keys.filter(k => {
            let nx = f.x + dirs[k].x; let ny = f.y + dirs[k].y;
            return nx >= 0 && nx < cfg.size && ny >= 0 && ny < cfg.size;
        });

        // –ò–ò —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –Ω–µ –≤—ã–ª–µ—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–µ 6 —Ö–æ–¥–æ–≤
        let move = (turnCount < 6 || Math.random() > 0.1) && safeKeys.length > 0 ? 
                   safeKeys[Math.floor(Math.random()*safeKeys.length)] : 
                   keys[Math.floor(Math.random()*keys.length)];

        const movePhrase = `${f.name} ${move}`;
        speak(movePhrase);
        updateStatus(movePhrase.toUpperCase());
        moveLogic(f, move, '–ò–ò');
        
        if(f.out) {
            aiTimeout = setTimeout(() => endGame(`–ò–ò –ü–û–ë–ï–î–ò–õ! –¢—ã –Ω–µ –∑–∞–º–µ—Ç–∏–ª –≤—ã–ª–µ—Ç –º—É—Ö–∏ ${f.name}`), 4000);
        } else {
            activeFlyIdx = (activeFlyIdx + 1) % cfg.count;
            turnCount++;
        }
    }

    function moveLogic(f, d, p) {
        f.x += dirs[d].x; f.y += dirs[d].y; f.lastDir = d;
        const entry = `<div>${f.icon} ${p}: ${f.name} ${d}</div>`;
        document.getElementById('log').innerHTML = entry + document.getElementById('log').innerHTML;
        if(f.x < 0 || f.x >= cfg.size || f.y < 0 || f.y >= cfg.size) f.out = true;
    }

    function playerClaimOut() {
        clearTimeout(aiTimeout);
        if(flies.some(f => f.out)) endGame("–ü–û–ë–ï–î–ê! –¢–≤–æ—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –Ω–∞ –≤—ã—Å–æ—Ç–µ.");
        else endGame("–û–®–ò–ë–ö–ê! –ú—É—Ö–∞ –≤—Å–µ –µ—â–µ –Ω–∞ –ø–æ–ª–µ.");
    }

    function updateStatus(t) { document.getElementById('status').innerText = t; }
    function endGame(m) { gameOver = true; alert(m); location.reload(); }
</script>
</body>
</html>
