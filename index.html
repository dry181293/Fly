<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É—Ö–∞ PRO: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --primary: #58a6ff; --err: #f85149; --succ: #3fb950; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 450px; padding: 15px; box-sizing: border-box; position: relative; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); text-align: center; border: 1px solid #30363d; position: relative; }
        
        /* –ö–Ω–æ–ø–∫–∞ –ü–æ–º–æ—â–∏ */
        .help-btn { position: absolute; top: 15px; right: 15px; background: #30363d; border: none; color: var(--primary); width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; z-index: 10; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--primary); max-width: 400px; text-align: left; font-size: 14px; line-height: 1.5; }
        .modal-content h3 { margin-top: 0; color: var(--primary); text-align: center; }
        .close-modal { background: var(--primary); border: none; color: black; padding: 10px; width: 100%; border-radius: 10px; margin-top: 15px; font-weight: bold; }

        /* –ü–æ–ª–µ –∏ –∫–Ω–æ–ø–∫–∏ */
        .grid { display: grid; gap: 8px; margin: 15px auto; background: #30363d; padding: 8px; border-radius: 12px; transition: opacity 0.3s; }
        .grid.hidden-grid { opacity: 0; }
        .cell { width: 50px; height: 50px; background: #0d1117; border-radius: 6px; border: 1px solid #444; }
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .btn { border: none; border-radius: 12px; padding: 18px; font-size: 18px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-dir { background: #21262d; border: 1px solid #30363d; }
        .btn-dir:active { background: var(--primary); }
        .btn-out { grid-column: span 3; background: var(--err); font-size: 20px; box-shadow: 0 4px 0 #900; }
        .status { height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.1rem; color: var(--primary); font-weight: 600; }
        
        .setup-row { margin-bottom: 12px; text-align: left; }
        select, input { width: 100%; padding: 12px; border-radius: 8px; background: #0d1117; color: white; border: 1px solid #30363d; font-size: 16px; margin-top: 4px; }
        .history { background: #000; padding: 10px; border-radius: 8px; height: 60px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #8b949e; text-align: left; }
        .toggle-view { background: #30363d; color: #c9d1d9; padding: 10px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; border: none; width: 100%; font-size: 14px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <button class="help-btn" onclick="toggleModal(true)">?</button>
        <h2 style="color: var(--primary)">–¢—Ä–µ–Ω–∞–∂–µ—Ä "–ú—É—Ö–∞"</h2>
        <div class="setup-row">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ö:
            <select id="flyCount">
                <option value="1">1 –ú—É—Ö–∞ ü™∞</option>
                <option value="2">2 –ú—É—Ö–∏ ü™∞ü™∞</option>
                <option value="3">3 –ú—É—Ö–∏ ü™∞ü™∞ü™∞</option>
            </select>
        </div>
        <div class="setup-row">–†–∞–∑–º–µ—Ä –ø–æ–ª—è: <input type="number" id="size" value="3" min="3" max="5"></div>
        <div class="setup-row">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–ª–µ—Ç–∞:
            <select id="diff">
                <option value="0.05">–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è</option>
                <option value="0.12" selected>–°—Ä–µ–¥–Ω—è—è (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º)</option>
                <option value="0.25">–í—ã—Å–æ–∫–∞—è</option>
            </select>
        </div>
        <button onclick="startGame()" class="btn" style="background: var(--succ); width: 100%; color: #000;">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <div id="game" class="card hidden">
        <button class="help-btn" onclick="toggleModal(true)">?</button>
        <button id="toggleGrid" class="toggle-view" onclick="toggleGrid()">–°–∫—Ä—ã—Ç—å –ø–æ–ª–µ</button>
        <div id="status" class="status">–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è...</div>
        <div id="grid" class="grid"></div>
        <div class="controls">
            <div></div><button class="btn btn-dir" onclick="handleMove('–≤–≤–µ—Ä—Ö')">‚Üë</button><div></div>
            <button class="btn btn-dir" onclick="handleMove('–≤–ª–µ–≤–æ')">‚Üê</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–Ω–∏–∑')">‚Üì</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–ø—Ä–∞–≤–æ')">‚Üí</button>
            <button class="btn btn-out" onclick="playerClaimOut()">–ú–£–•–ê –í–´–õ–ï–¢–ï–õ–ê!</button>
        </div>
        <div id="log" class="history"></div>
        <button onclick="location.reload()" style="margin-top: 15px; background: none; border: none; color: #58a6ff; font-size: 14px; cursor: pointer;">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
    </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <h3>–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h3>
        <ul>
            <li><b>–°—É—Ç—å:</b> –ú—ã—Å–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –º—É—Ö –ø–æ –ø–æ–ª—é, –∑–∞–ø–æ–º–∏–Ω–∞—è –∏—Ö –ø–æ–ª–æ–∂–µ–Ω–∏–µ.</li>
            <li><b>–ù–∞—á–∞–ª–æ:</b> –ò–≥—Ä–∞ —Å—Ç–∞—Ä—Ç—É–µ—Ç –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –∫–ª–µ—Ç–∫–∏.</li>
            <li><b>–•–æ–¥—ã:</b> –ò–≥—Ä–æ–∫ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä —Ö–æ–¥—è—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏.</li>
            <li><b>–ó–∞–ø—Ä–µ—Ç:</b> –ù–µ–ª—å–∑—è —Ö–æ–¥–∏—Ç—å –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏, –æ–±—Ä–∞—Ç–Ω–æ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É (–Ω–∞–∑–∞–¥).</li>
            <li><b>–í—ã–ª–µ—Ç:</b> –ï—Å–ª–∏ –º—É—Ö–∞ –ø–æ–∫–∏–Ω—É–ª–∞ –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è (–Ω–∞–ø—Ä. –±—ã–ª–∞ –Ω–∞ –∫—Ä–∞—é –∏ –ø–æ–ª–µ—Ç–µ–ª–∞ –¥–∞–ª—å—à–µ), –Ω—É–∂–Ω–æ <b>–ø–µ—Ä–≤—ã–º</b> –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–í–´–õ–ï–¢–ï–õ–ê".</li>
            <li><b>–ö–Ω–æ–ø–∫–∏:</b> –°—Ç—Ä–µ–ª–∫–∏ ‚Äî –≤–∞—à —Ö–æ–¥. –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Äî –∑–∞—è–≤–∏—Ç—å –æ –≤—ã–ª–µ—Ç–µ.</li>
        </ul>
        <button class="close-modal" onclick="toggleModal(false)">–ü–û–ù–Ø–¢–ù–û</button>
    </div>
</div>

<script>
    let cfg = { size: 3, count: 1, diff: 0.12 };
    let flies = [];
    let activeFlyIdx = 0;
    let gameOver = false;
    let aiTimeout;
    const dirs = { '–≤–≤–µ—Ä—Ö': {x: 0, y: -1}, '–≤–Ω–∏–∑': {x: 0, y: 1}, '–≤–ª–µ–≤–æ': {x: -1, y: 0}, '–≤–ø—Ä–∞–≤–æ': {x: 1, y: 0} };
    const opposites = { '–≤–≤–µ—Ä—Ö': '–≤–Ω–∏–∑', '–≤–Ω–∏–∑': '–≤–≤–µ—Ä—Ö', '–≤–ª–µ–≤–æ': '–≤–ø—Ä–∞–≤–æ', '–≤–ø—Ä–∞–≤–æ': '–≤–ª–µ–≤–æ' };
    const colors = ['–ö—Ä–∞—Å–Ω–∞—è', '–ó–µ–ª–µ–Ω–∞—è', '–ñ–µ–ª—Ç–∞—è'];

    function toggleModal(show) { document.getElementById('helpModal').style.display = show ? 'flex' : 'none'; }
    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'ru-RU'; window.speechSynthesis.speak(m); }
    function toggleGrid() {
        const g = document.getElementById('grid');
        const b = document.getElementById('toggleGrid');
        g.classList.toggle('hidden-grid');
        b.innerText = g.classList.contains('hidden-grid') ? "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ" : "–°–∫—Ä—ã—Ç—å –ø–æ–ª–µ (Hard Mode)";
    }

    function startGame() {
        cfg.size = parseInt(document.getElementById('size').value);
        cfg.count = parseInt(document.getElementById('flyCount').value);
        cfg.diff = parseFloat(document.getElementById('diff').value);
        flies = [];
        for(let i=0; i<cfg.count; i++) flies.push({ x: Math.floor(cfg.size/2), y: Math.floor(cfg.size/2), name: colors[i], out: false, lastDir: null });
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(${cfg.size}, 1fr)`;
        g.innerHTML = '';
        for(let i=0; i<cfg.size*cfg.size; i++) g.innerHTML += `<div class="cell"></div>`;
        speak(`${flies[0].name} –º—É—Ö–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ`);
        updateStatus(`–•–æ–¥–∏—Ç: ${flies[0].name}`);
        setTimeout(aiMove, 1500);
    }

    function handleMove(d) {
        if(gameOver) return;
        let f = flies[activeFlyIdx];
        if(f.lastDir && d === opposites[f.lastDir]) {
            speak("–û—à–∏–±–∫–∞! –û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥.");
            return endGame("–ü—Ä–æ–∏–≥—Ä—ã—à! –ù–∞–∑–∞–¥ —Ö–æ–¥–∏—Ç—å –Ω–µ–ª—å–∑—è.");
        }
        moveLogic(f, d, '–¢—ã');
        updateStatus(`–¢–≤–æ–π —Ö–æ–¥: ${d.toUpperCase()}`);
        if(f.out) aiTimeout = setTimeout(() => endGame(`–ò–ò –ü–û–ë–ï–î–ò–õ! ${f.name} –º—É—Ö–∞ –≤—ã–ª–µ—Ç–µ–ª–∞.`), 3500);
        else { activeFlyIdx = (activeFlyIdx + 1) % cfg.count; setTimeout(aiMove, 1000); }
    }

    function aiMove() {
        if(gameOver || flies.some(f => f.out)) return;
        let f = flies[activeFlyIdx];
        let keys = Object.keys(dirs).filter(k => k !== opposites[f.lastDir]);
        let safe = keys.filter(k => {
            let nx = f.x + dirs[k].x; let ny = f.y + dirs[k].y;
            return nx >= 0 && nx < cfg.size && ny >= 0 && ny < cfg.size;
        });
        let move = (Math.random() < cfg.diff || safe.length === 0) ? keys[Math.floor(Math.random()*keys.length)] : safe[Math.floor(Math.random()*safe.length)];
        speak(`${f.name} ${move}`);
        updateStatus(`${f.name}: ${move.toUpperCase()}`);
        moveLogic(f, move, '–ò–ò');
        if(f.out) aiTimeout = setTimeout(() => endGame(`–ò–ò –ü–û–ë–ï–î–ò–õ! –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≤—ã–ª–µ—Ç –º—É—Ö–∏: ${f.name}`), 4000);
        else activeFlyIdx = (activeFlyIdx + 1) % cfg.count;
    }

    function moveLogic(f, d, p) {
        f.x += dirs[d].x; f.y += dirs[d].y; f.lastDir = d;
        document.getElementById('log').innerHTML = `<div>${p}: ${f.name} ${d}</div>` + document.getElementById('log').innerHTML;
        if(f.x < 0 || f.x >= cfg.size || f.y < 0 || f.y >= cfg.size) f.out = true;
    }

    function playerClaimOut() {
        clearTimeout(aiTimeout);
        if(flies.some(f => f.out)) endGame("–ü–û–ë–ï–î–ê! –í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è.");
        else endGame("–û–®–ò–ë–ö–ê! –ú—É—Ö–∞ –≤—Å–µ –µ—â–µ –Ω–∞ –ø–æ–ª–µ.");
    }

    function updateStatus(t) { document.getElementById('status').innerText = t; }
    function endGame(m) { gameOver = true; alert(m); location.reload(); }
</script>
</body>
</html>
