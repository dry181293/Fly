<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É—Ö–∞ PRO: –ì—Ä–æ—Å—Å–º–µ–π—Å—Ç–µ—Ä</title>
    <style>
        :root { --bg: #0b0e14; --panel: #161b22; --primary: #7928ca; --accent: #ff0080; --succ: #00dfd8; --text: #e6edf3; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0b0e14; color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 420px; padding: 20px; box-sizing: border-box; }
        
        .card { background: var(--panel); border-radius: 24px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #30363d; text-align: center; position: relative; animation: cardEnter 0.4s ease-out; }
        @keyframes cardEnter { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* –°—Ç–∞—Ç—É—Å –∏ –û—á–µ—Ä–µ–¥—å */
        .status-box { min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .turn-tag { font-size: 0.75rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1.5px; border: 1px solid var(--primary); padding: 2px 10px; border-radius: 10px; margin-bottom: 8px; }

        .grid-container { min-height: 190px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .grid { display: grid; gap: 8px; background: #30363d; padding: 10px; border-radius: 16px; transition: 0.3s; }
        .grid.hidden-grid { opacity: 0; transform: scale(0.9); pointer-events: none; }
        .cell { width: 50px; height: 50px; background: #0d1117; border-radius: 8px; border: 1px solid #21262d; }

        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .btn { border: none; border-radius: 16px; cursor: pointer; color: white; transition: 0.15s; font-weight: bold; }
        .btn-dir { background: #21262d; border: 1px solid #30363d; height: 60px; font-size: 1.5rem; }
        .btn-dir:active:not(:disabled) { background: var(--primary); transform: scale(0.9); }
        .btn-dir:disabled { opacity: 0.2; cursor: default; }
        
        .btn-out { grid-column: span 3; background: linear-gradient(90deg, var(--accent), var(--primary)); padding: 20px; font-size: 1.1rem; text-transform: uppercase; }

        .setup-row { margin-bottom: 12px; text-align: left; }
        label { font-size: 11px; color: #8b949e; display: block; margin-bottom: 4px; text-transform: uppercase; }
        select, input { width: 100%; padding: 10px; border-radius: 10px; background: #0d1117; color: white; border: 1px solid #30363d; font-size: 15px; }

        .history { background: #000; padding: 12px; border-radius: 12px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #8b949e; border: 1px solid #21262d; }
        .log-line { border-bottom: 1px solid #1a1a1a; padding: 3px 0; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .hidden { display: none; }
        .pulse { animation: pulse 0.4s ease; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <h2 style="margin:0 0 20px 0">ü™∞ –ú–£–•–ê PRO</h2>
        
        <div class="setup-row">
            <label>–¶–≤–µ—Ç —Ç–≤–æ–µ–π –º—É—Ö–∏:</label>
            <select id="pColor">
                <option value="0">–ö—Ä–∞—Å–Ω–∞—è üî¥</option>
                <option value="1" selected>–ó–µ–ª–µ–Ω–∞—è üü¢</option>
                <option value="2">–°–∏–Ω—è—è üîµ</option>
                <option value="3">–ñ–µ–ª—Ç–∞—è üü°</option>
                <option value="4">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è üü£</option>
            </select>
        </div>

        <div class="setup-row">
            <label>–¶–µ–ø–æ—á–∫–∞ (–ò–ò-–±–æ—Ç–æ–≤):</label>
            <select id="aiCount">
                <option value="1">1 –ë–æ—Ç (–ê–ª—å—Ñ–∞ ü§ñ)</option>
                <option value="2">2 –ë–æ—Ç–∞ (–ê–ª—å—Ñ–∞, –ë–µ—Ç–∞ ü¶æ)</option>
                <option value="3">3 –ë–æ—Ç–∞ (–ê–ª—å—Ñ–∞, –ë–µ—Ç–∞, –ì–∞–º–º–∞ ‚öôÔ∏è)</option>
            </select>
        </div>

        <div class="setup-row">
            <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å (—Ä–∏—Å–∫ –≤—ã–ª–µ—Ç–∞):</label>
            <select id="difficulty">
                <option value="0.03">–ù–∏–∑–∫–∞—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ)</option>
                <option value="0.1" selected>–°—Ä–µ–¥–Ω—è—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                <option value="0.25">–í—ã—Å–æ–∫–∞—è (–æ–ø–∞—Å–Ω–æ)</option>
            </select>
        </div>

        <div class="setup-row">
            <label>–ö–æ–ª-–≤–æ –º—É—Ö:</label>
            <select id="flyCount">
                <option value="1">1 –ú—É—Ö–∞</option>
                <option value="2">2 –ú—É—Ö–∏</option>
            </select>
        </div>

        <button onclick="startGame()" class="btn btn-out" style="margin-top: 10px;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>

    <div id="game" class="card hidden">
        <div id="turnTag" class="turn-tag">–û—á–µ—Ä–µ–¥—å</div>
        <div class="status-box" id="status"></div>
        
        <button id="toggleGrid" style="background:none; border:1px solid #30363d; color:#555; padding:4px 12px; border-radius:20px; cursor:pointer; font-size:10px; margin-bottom:10px;" onclick="toggleGrid()">üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ</button>

        <div class="grid-container"><div id="grid" class="grid"></div></div>
        
        <div class="controls" id="controls">
            <div></div><button class="btn btn-dir" onclick="handleMove('–≤–≤–µ—Ä—Ö')">‚Üë</button><div></div>
            <button class="btn btn-dir" onclick="handleMove('–≤–ª–µ–≤–æ')">‚Üê</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–Ω–∏–∑')">‚Üì</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–ø—Ä–∞–≤–æ')">‚Üí</button>
            <button class="btn btn-out" onclick="playerClaimOut()">–ú—É—Ö–∞ –≤—ã–ª–µ—Ç–µ–ª–∞!</button>
        </div>
        <div id="log" class="history"></div>
    </div>
</div>

<script>
    const flyMeta = [
        { name: '–ö—Ä–∞—Å–Ω–∞—è –º—É—Ö–∞', icon: 'üî¥' }, { name: '–ó–µ–ª–µ–Ω–∞—è –º—É—Ö–∞', icon: 'üü¢' },
        { name: '–°–∏–Ω—è—è –º—É—Ö–∞', icon: 'üîµ' }, { name: '–ñ–µ–ª—Ç–∞—è –º—É—Ö–∞', icon: 'üü°' }, { name: '–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –º—É—Ö–∞', icon: 'üü£' }
    ];
    const aiBots = [{ n: '–ò–ò –ê–ª—å—Ñ–∞', i: 'ü§ñ' }, { n: '–ò–ò –ë–µ—Ç–∞', i: 'ü¶æ' }, { n: '–ò–ò –ì–∞–º–º–∞', i: '‚öôÔ∏è' }];

    let cfg = { size: 3, fCount: 1, aiCount: 1, diff: 0.1 };
    let flies = [];
    let turnChain = [];
    let chainIdx = 0;
    let activeFlyIdx = 0;
    let moveCount = 0;
    let gameOver = false;
    let aiWait;

    const dirs = { '–≤–≤–µ—Ä—Ö': {x: 0, y: -1}, '–≤–Ω–∏–∑': {x: 0, y: 1}, '–≤–ª–µ–≤–æ': {x: -1, y: 0}, '–≤–ø—Ä–∞–≤–æ': {x: 1, y: 0} };
    const opposites = { '–≤–≤–µ—Ä—Ö': '–≤–Ω–∏–∑', '–≤–Ω–∏–∑': '–≤–≤–µ—Ä—Ö', '–≤–ª–µ–≤–æ': '–≤–ø—Ä–∞–≤–æ', '–≤–ø—Ä–∞–≤–æ': '–≤–ª–µ–≤–æ' };

    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'ru-RU'; window.speechSynthesis.speak(m); }
    function toggleGrid() { 
        const g = document.getElementById('grid'); g.classList.toggle('hidden-grid');
        document.getElementById('toggleGrid').innerText = g.classList.contains('hidden-grid') ? "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ" : "üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ";
    }

    function startGame() {
        cfg.fCount = parseInt(document.getElementById('flyCount').value);
        cfg.aiCount = parseInt(document.getElementById('aiCount').value);
        cfg.diff = parseFloat(document.getElementById('difficulty').value);
        const cStart = parseInt(document.getElementById('pColor').value);

        flies = [];
        for(let i=0; i<cfg.fCount; i++) {
            let m = flyMeta[(cStart + i) % flyMeta.length];
            flies.push({ x: 1, y: 1, ...m, out: false, last: null });
        }

        turnChain = ['user'];
        for(let i=0; i<cfg.aiCount; i++) turnChain.push('ai' + i);

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        
        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(3, 1fr)`;
        for(let i=0; i<9; i++) g.innerHTML += `<div class="cell"></div>`;

        // –ü–ï–†–í–´–ô –•–û–î (–ò–ò –ê–ª—å—Ñ–∞)
        const f = flies[0];
        const d = Object.keys(dirs)[Math.floor(Math.random()*4)];
        const msg = `${f.name} –≤ —Ü–µ–Ω—Ç—Ä–µ ‚Äî ${f.name} ${d}`;
        updateStatus(`${f.icon} ${msg}`);
        speak(msg);
        moveLogic(f, d, aiBots[0].n, aiBots[0].i);
        
        chainIdx = 0; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–∞–∫ –∫–∞–∫ –ò–ò —É–∂–µ –ø–æ—Ö–æ–¥–∏–ª)
        nextTurn();
    }

    function nextTurn() {
        if(gameOver) return;
        chainIdx = (chainIdx + 1) % turnChain.length;
        const id = turnChain[chainIdx];

        if(id === 'user') {
            document.getElementById('turnTag').innerText = "–¢–≤–æ–π —Ö–æ–¥";
            toggleBtns(true);
        } else {
            const idx = parseInt(id.replace('ai', ''));
            document.getElementById('turnTag').innerText = `–•–æ–¥–∏—Ç ${aiBots[idx].n}`;
            toggleBtns(false);
            setTimeout(() => performAiMove(idx), 1200);
        }
    }

    function handleMove(d) {
        if(gameOver) return;
        let f = flies[activeFlyIdx];
        if(f.last && d === opposites[f.last]) {
            speak("–û—à–∏–±–∫–∞! –ù–∞–∑–∞–¥ –Ω–µ–ª—å–∑—è.");
            return endGame("–ü—Ä–æ–∏–≥—Ä—ã—à! –û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥ –∑–∞–ø—Ä–µ—â–µ–Ω.");
        }
        moveLogic(f, d, '–¢—ã', 'üë§');
        if(f.out) aiWait = setTimeout(() => endGame(`–ò–ò –ó–ê–ú–ï–¢–ò–õ! ${f.name} —É–ª–µ—Ç–µ–ª–∞.`), 3500);
        else { activeFlyIdx = (activeFlyIdx + 1) % cfg.fCount; moveCount++; nextTurn(); }
    }

    function performAiMove(idx) {
        if(gameOver || flies.some(fl => fl.out)) return;
        let f = flies[activeFlyIdx];
        let bot = aiBots[idx];
        
        let keys = Object.keys(dirs).filter(k => k !== opposites[f.last]);
        let safe = keys.filter(k => { 
            let nx = f.x + dirs[k].x; let ny = f.y + dirs[k].y; 
            return nx >= 0 && nx < 3 && ny >= 0 && ny < 3; 
        });

        // –ò–°–ü–û–õ–¨–ó–£–ï–ú –°–õ–û–ñ–ù–û–°–¢–¨ (diff)
        let move = (moveCount < 5 || Math.random() > cfg.diff) && safe.length > 0 ? 
                   safe[Math.floor(Math.random()*safe.length)] : 
                   keys[Math.floor(Math.random()*keys.length)];

        const msg = `${f.name} ${move}`;
        updateStatus(`${f.icon} ${msg.toUpperCase()}`);
        speak(msg);
        moveLogic(f, move, bot.n, bot.i);

        if(f.out) aiWait = setTimeout(() => endGame(`–ò–ò –ü–û–ë–ï–î–ò–õ! –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≤—ã–ª–µ—Ç ${f.name}`), 4000);
        else { activeFlyIdx = (activeFlyIdx + 1) % cfg.fCount; moveCount++; nextTurn(); }
    }

    function moveLogic(f, d, pName, pIcon) {
        f.x += dirs[d].x; f.y += dirs[d].y; f.last = d;
        const log = document.getElementById('log');
        log.innerHTML = `<div class="log-line">${pIcon} ${pName}: ${f.icon} ${d}</div>` + log.innerHTML;
        const sb = document.getElementById('status');
        sb.classList.remove('pulse'); void sb.offsetWidth; sb.classList.add('pulse');
        if(f.x < 0 || f.x >= 3 || f.y < 0 || f.y >= 3) f.out = true;
    }

    function playerClaimOut() {
        clearTimeout(aiWait);
        if(flies.some(f => f.out)) endGame("–ü–û–ë–ï–î–ê! –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –Ω–∞ –≤—ã—Å–æ—Ç–µ.");
        else endGame("–û–®–ò–ë–ö–ê! –ú—É—Ö–∞ –µ—â–µ –Ω–∞ –ø–æ–ª–µ.");
    }

    function toggleBtns(on) { document.querySelectorAll('.btn-dir').forEach(b => b.disabled = !on); }
    function updateStatus(t) { document.getElementById('status').innerText = t; }
    function endGame(m) { gameOver = true; alert(m); location.reload(); }
</script>
</body>
</html>
