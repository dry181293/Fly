<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É—Ö–∞ PRO: Animated</title>
    <style>
        :root { --bg: #0b0e14; --panel: #161b22; --primary: #7928ca; --accent: #ff0080; --succ: #00dfd8; --text: #e6edf3; --err: #ff4d4d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: radial-gradient(circle at center, #1a1f2c 0%, #0b0e14 100%); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; overflow-x: hidden; }
        .container { width: 100%; max-width: 420px; padding: 20px; box-sizing: border-box; perspective: 1000px; }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è */
        .card { background: var(--panel); border-radius: 24px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #30363d; text-align: center; position: relative; width: 100%; box-sizing: border-box; transition: transform 0.3s ease, opacity 0.3s ease; animation: cardEnter 0.5s ease-out; }
        @keyframes cardEnter { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .card.shake-anim { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* –ñ—É–∂–∂–∞—â–∞—è –º—É—Ö–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ */
        .title-fly { display: inline-block; font-size: 2rem; animation: hoverBuzz 1.5s ease-in-out infinite alternate; }
        @keyframes hoverBuzz { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(2deg); } 100% { transform: translateY(0) rotate(-2deg); } }

        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .help-btn { background: #30363d; border: none; color: var(--primary); width: 32px; height: 32px; border-radius: 50%; font-weight: bold; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .help-btn:hover { transform: rotate(15deg) scale(1.1); background: var(--primary); color: white; }

        /* –°—Ç–∞—Ç—É—Å —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π */
        .status-box { min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; line-height: 1.4; margin-bottom: 10px; color: #fff; transition: color 0.3s; }
        .status-box.pulse { animation: textPulse 0.5s ease-in-out; }
        @keyframes textPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); color: var(--succ); } 100% { transform: scale(1); } }
        
        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫–∏ */
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .btn { border: none; border-radius: 16px; cursor: pointer; color: white; transition: all 0.15s cubic-bezier(0.25, 0.8, 0.25, 1); font-weight: bold; position: relative; overflow: hidden; }
        .btn-dir { background: #21262d; border: 1px solid #30363d; height: 60px; font-size: 1.5rem; }
        .btn-dir:active { transform: scale(0.92); background: var(--primary); box-shadow: 0 0 15px var(--primary); }
        
        .btn-out { grid-column: span 3; background: linear-gradient(90deg, var(--accent), var(--primary)); padding: 20px; font-size: 1.2rem; border-radius: 18px; box-shadow: 0 4px 15px rgba(255,0,128,0.3); text-transform: uppercase; }
        .btn-out:active { transform: scale(0.95); }

        /* –õ–æ–≥ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π */
        .history { background: #000; padding: 12px; border-radius: 12px; height: 120px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #8b949e; text-align: left; border: 1px solid #21262d; }
        .log-entry { animation: slideInTop 0.3s ease-out; border-bottom: 1px solid #21262d; padding: 4px 0; }
        @keyframes slideInTop { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .grid-container { min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .grid { display: grid; gap: 8px; background: #30363d; padding: 10px; border-radius: 16px; transition: 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .grid.hidden-grid { opacity: 0; transform: scale(0.8) rotate(5deg); pointer-events: none; }
        .cell { width: 50px; height: 50px; background: #0d1117; border-radius: 8px; border: 1px solid #21262d; }
        .setup-row { margin-bottom: 15px; text-align: left; }
        label { font-size: 14px; color: #8b949e; display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 12px; border-radius: 10px; background: #0d1117; color: white; border: 1px solid #30363d; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        select:focus, input:focus { border-color: var(--primary); outline: none; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        .modal-content { background: var(--panel); padding: 25px; border-radius: 24px; border: 1px solid var(--primary); max-width: 400px; animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes scaleIn { from {transform: scale(0.8);} to {transform: scale(1);} }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <div class="header-area">
            <h2 style="margin:0"><span class="title-fly">ü™∞</span> –ú—É—Ö–∞ PRO</h2>
            <button class="help-btn" onclick="toggleModal(true)">?</button>
        </div>
        
        <div class="setup-row">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ö:</label>
            <select id="flyCount">
                <option value="1">1 –ú—É—Ö–∞ üî¥</option>
                <option value="2">2 –ú—É—Ö–∏ üî¥ üü¢</option>
                <option value="3">3 –ú—É—Ö–∏ üî¥ üü¢ üü°</option>
            </select>
        </div>
        <div class="setup-row">
            <label>–†–∞–∑–º–µ—Ä –ø–æ–ª—è:</label>
            <input type="number" id="size" value="3" min="3" max="5">
        </div>
        <div class="setup-row">
            <label>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–ª–µ—Ç–∞:</label>
            <select id="diff">
                <option value="0.04">–ù–∏–∑–∫–∞—è (–¥–ª–∏–Ω–Ω–∞—è –∏–≥—Ä–∞)</option>
                <option value="0.1" selected>–°—Ä–µ–¥–Ω—è—è (–Ω–æ—Ä–º–∞)</option>
                <option value="0.25">–í—ã—Å–æ–∫–∞—è (–æ–ø–∞—Å–Ω–æ)</option>
            </select>
        </div>
        <button onclick="startGame()" class="btn btn-out" style="margin-top: 10px;">–í–∑–ª–µ—Ç–∞–µ–º!</button>
    </div>

    <div id="game" class="card hidden">
        <button class="help-btn" style="position:absolute; top:15px; right:15px" onclick="toggleModal(true)">?</button>
        <button id="toggleGrid" style="background:none; border:1px solid #30363d; color:#8b949e; padding:5px 15px; border-radius:20px; cursor:pointer; font-size:12px; margin-bottom:10px; transition:0.3s" onclick="toggleGrid()">üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ</button>
        
        <div class="status-box" id="status"></div>
        
        <div class="grid-container"><div id="grid" class="grid"></div></div>
        
        <div class="controls">
            <div></div><button class="btn btn-dir" onclick="handleMove('–≤–≤–µ—Ä—Ö')">‚Üë</button><div></div>
            <button class="btn btn-dir" onclick="handleMove('–≤–ª–µ–≤–æ')">‚Üê</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–Ω–∏–∑')">‚Üì</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–ø—Ä–∞–≤–æ')">‚Üí</button>
            <button class="btn btn-out" onclick="playerClaimOut()">–ú—É—Ö–∞ –≤—ã–ª–µ—Ç–µ–ª–∞!</button>
        </div>
        
        <div id="log" class="history"></div>
        <button onclick="location.reload()" style="margin-top:15px; background:none; border:none; color:#555; cursor:pointer; transition:0.3s;">–í –º–µ–Ω—é</button>
    </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--primary); margin-top:0">–ü—Ä–∞–≤–∏–ª–∞:</h3>
        <ul style="text-align:left; font-size:14px; padding-left:20px">
            <li>–î–µ—Ä–∂–∏ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –º—É—Ö –≤ —É–º–µ.</li>
            <li><b>–û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥ –∑–∞–ø—Ä–µ—â–µ–Ω!</b></li>
            <li>–ü–µ—Ä–≤—ã–µ 5 —Ö–æ–¥–æ–≤ ‚Äî —Ä–∞–∑–º–∏–Ω–∫–∞ (–±–µ–∑ –≤—ã–ª–µ—Ç–æ–≤).</li>
            <li>–ú—É—Ö–∞ —É—à–ª–∞ –∑–∞ –∫—Ä–∞–π? –ñ–º–∏ –∫—Ä–∞—Å–Ω—É—é –∫–Ω–æ–ø–∫—É!</li>
        </ul>
        <button class="btn btn-out" style="padding:10px; width:100%" onclick="toggleModal(false)">–ü–æ–Ω—è–ª</button>
    </div>
</div>

<script>
    let cfg = { size: 3, count: 1, diff: 0.1 };
    let flies = [];
    let activeFlyIdx = 0;
    let turnCounter = 0;
    let gameOver = false;
    let aiWait;
    const dirs = { '–≤–≤–µ—Ä—Ö': {x: 0, y: -1}, '–≤–Ω–∏–∑': {x: 0, y: 1}, '–≤–ª–µ–≤–æ': {x: -1, y: 0}, '–≤–ø—Ä–∞–≤–æ': {x: 1, y: 0} };
    const opposites = { '–≤–≤–µ—Ä—Ö': '–≤–Ω–∏–∑', '–≤–Ω–∏–∑': '–≤–≤–µ—Ä—Ö', '–≤–ª–µ–≤–æ': '–≤–ø—Ä–∞–≤–æ', '–≤–ø—Ä–∞–≤–æ': '–≤–ª–µ–≤–æ' };
    const flyMeta = [{ name: '–ö—Ä–∞—Å–Ω–∞—è –º—É—Ö–∞', icon: 'üî¥' }, { name: '–ó–µ–ª–µ–Ω–∞—è –º—É—Ö–∞', icon: 'üü¢' }, { name: '–ñ–µ–ª—Ç–∞—è –º—É—Ö–∞', icon: 'üü°' }];

    function toggleModal(s) { document.getElementById('helpModal').style.display = s ? 'flex' : 'none'; }
    function toggleGrid() {
        const g = document.getElementById('grid'); g.classList.toggle('hidden-grid');
        document.getElementById('toggleGrid').innerText = g.classList.contains('hidden-grid') ? "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ" : "üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ";
    }
    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'ru-RU'; window.speechSynthesis.speak(m); }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—É–ª—å—Å–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
    function triggerStatusPulse() {
        const s = document.getElementById('status');
        s.classList.remove('pulse');
        void s.offsetWidth; // –¢—Ä–∏–≥–≥–µ—Ä reflow –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
        s.classList.add('pulse');
    }

    function startGame() {
        cfg.size = parseInt(document.getElementById('size').value);
        cfg.count = parseInt(document.getElementById('flyCount').value);
        cfg.diff = parseFloat(document.getElementById('diff').value);
        flies = [];
        for(let i=0; i<cfg.count; i++) flies.push({ x: Math.floor(cfg.size/2), y: Math.floor(cfg.size/2), name: flyMeta[i].name, icon: flyMeta[i].icon, out: false, last: null });

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(${cfg.size}, 1fr)`;
        g.innerHTML = '';
        for(let i=0; i<cfg.size*cfg.size; i++) g.innerHTML += `<div class="cell"></div>`;

        const f = flies[0]; const d = Object.keys(dirs)[Math.floor(Math.random()*4)];
        const phrase = `${f.name} –≤ —Ü–µ–Ω—Ç—Ä–µ ‚Äî ${f.name} ${d}`;
        updateStatus(`${f.icon} ${phrase}`);
        speak(phrase);
        moveLogic(f, d, '–ò–ò');
    }

    function handleMove(d) {
        if(gameOver) return;
        let f = flies[activeFlyIdx];
        if(f.last && d === opposites[f.last]) {
            speak("–û—à–∏–±–∫–∞! –û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥.");
            triggerErrorShake();
            return endGame("–ü—Ä–æ–∏–≥—Ä—ã—à! –ù–∞–∑–∞–¥ —Ö–æ–¥–∏—Ç—å –Ω–µ–ª—å–∑—è.");
        }
        updateStatus(`${f.icon} –¢–≤–æ–π —Ö–æ–¥: ${d.toUpperCase()}`);
        moveLogic(f, d, '–¢—ã');
        if(f.out) { aiWait = setTimeout(() => { triggerErrorShake(); endGame(`–ò–ò –ó–ê–ú–ï–¢–ò–õ! ${f.name} —É–ª–µ—Ç–µ–ª–∞.`); }, 3500); }
        else { activeFlyIdx = (activeFlyIdx + 1) % cfg.count; turnCounter++; setTimeout(aiMove, 1200); }
    }

    function aiMove() {
        if(gameOver || flies.some(fl => fl.out)) return;
        let f = flies[activeFlyIdx];
        let keys = Object.keys(dirs).filter(k => k !== opposites[f.last]);
        let safe = keys.filter(k => { let nx = f.x + dirs[k].x; let ny = f.y + dirs[k].y; return nx >= 0 && nx < cfg.size && ny >= 0 && ny < cfg.size; });
        let move = (turnCounter < 5 || Math.random() > cfg.diff) && safe.length > 0 ? safe[Math.floor(Math.random()*safe.length)] : keys[Math.floor(Math.random()*keys.length)];
        const phrase = `${f.name} ${move}`;
        updateStatus(`${f.icon} ${phrase.toUpperCase()}`);
        speak(phrase);
        moveLogic(f, move, '–ò–ò');
        if(f.out) { aiWait = setTimeout(() => { triggerErrorShake(); endGame(`–ò–ò –ü–û–ë–ï–î–ò–õ! –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≤—ã–ª–µ—Ç –º—É—Ö–∏ ${f.name}`); }, 4000); }
        else { activeFlyIdx = (activeFlyIdx + 1) % cfg.count; turnCounter++; }
    }

    function moveLogic(f, d, p) {
        f.x += dirs[d].x; f.y += dirs[d].y; f.last = d;
        const entry = `<div class="log-entry">${f.icon} ${p}: ${d}</div>`;
        const log = document.getElementById('log');
        log.innerHTML = entry + log.innerHTML;
        triggerStatusPulse(); // –ü—É–ª—å—Å–∞—Ü–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ö–æ–¥–µ
        if(f.x < 0 || f.x >= cfg.size || f.y < 0 || f.y >= cfg.size) f.out = true;
    }

    function playerClaimOut() {
        clearTimeout(aiWait);
        if(flies.some(f => f.out)) endGame("–ü–û–ë–ï–î–ê! –¢—ã –≤–æ–≤—Ä–µ–º—è –∑–∞–º–µ—Ç–∏–ª –≤—ã–ª–µ—Ç.");
        else { triggerErrorShake(); endGame("–û–®–ò–ë–ö–ê! –ú—É—Ö–∞ –≤—Å–µ –µ—â–µ –Ω–∞ –ø–æ–ª–µ."); }
    }

    function triggerErrorShake() {
        const gameCard = document.getElementById('game');
        gameCard.classList.add('shake-anim');
        setTimeout(() => gameCard.classList.remove('shake-anim'), 500);
    }

    function updateStatus(t) { document.getElementById('status').innerText = t; }
    function endGame(m) { gameOver = true; setTimeout(() => { alert(m); location.reload(); }, 300); }
</script>
</body>
</html>
