<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É—Ö–∞ PRO: –¶–µ–ø–æ—á–∫–∞ –ò–≥—Ä–æ–∫–æ–≤</title>
    <style>
        :root { --bg: #0b0e14; --panel: #161b22; --primary: #7928ca; --accent: #ff0080; --succ: #00dfd8; --text: #e6edf3; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: radial-gradient(circle at center, #1a1f2c 0%, #0b0e14 100%); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 420px; padding: 20px; box-sizing: border-box; }
        
        .card { background: var(--panel); border-radius: 24px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #30363d; text-align: center; position: relative; animation: cardEnter 0.5s ease-out; }
        @keyframes cardEnter { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .status-box { min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #fff; line-height: 1.4; }
        .turn-indicator { font-size: 0.8rem; color: var(--succ); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }

        .grid-container { min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .grid { display: grid; gap: 8px; background: #30363d; padding: 10px; border-radius: 16px; transition: 0.4s; }
        .grid.hidden-grid { opacity: 0; transform: scale(0.9); pointer-events: none; }
        .cell { width: 50px; height: 50px; background: #0d1117; border-radius: 8px; border: 1px solid #21262d; }

        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .btn { border: none; border-radius: 16px; cursor: pointer; color: white; transition: 0.15s; font-weight: bold; }
        .btn-dir { background: #21262d; border: 1px solid #30363d; height: 60px; font-size: 1.5rem; }
        .btn-dir:active { background: var(--primary); transform: scale(0.9); }
        .btn-dir:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .btn-out { grid-column: span 3; background: linear-gradient(90deg, var(--accent), var(--primary)); padding: 20px; font-size: 1.2rem; text-transform: uppercase; box-shadow: 0 4px 15px rgba(255,0,128,0.3); }

        .setup-row { margin-bottom: 15px; text-align: left; }
        label { font-size: 12px; color: #8b949e; display: block; margin-bottom: 4px; text-transform: uppercase; }
        select, input { width: 100%; padding: 12px; border-radius: 12px; background: #0d1117; color: white; border: 1px solid #30363d; font-size: 16px; }

        .history { background: #000; padding: 12px; border-radius: 12px; height: 110px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #8b949e; border: 1px solid #21262d; }
        .log-item { border-bottom: 1px solid #222; padding: 4px 0; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        
        .hidden { display: none; }
        .pulse { animation: pulseAnim 0.4s ease-out; }
        @keyframes pulseAnim { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <h2 style="margin:0 0 20px 0">ü™∞ –ú–£–•–ê PRO: –¶–ï–ü–û–ß–ö–ê</h2>
        
        <div class="setup-row">
            <label>–í–∞—à —Ü–≤–µ—Ç:</label>
            <select id="primaryColor">
                <option value="0">–ö—Ä–∞—Å–Ω–∞—è üî¥</option>
                <option value="1" selected>–ó–µ–ª–µ–Ω–∞—è üü¢</option>
                <option value="2">–°–∏–Ω—è—è üîµ</option>
                <option value="3">–ñ–µ–ª—Ç–∞—è üü°</option>
                <option value="4">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è üü£</option>
            </select>
        </div>

        <div class="setup-row">
            <label>–ò–≥—Ä–æ–∫–æ–≤ –ò–ò –≤ —Ü–µ–ø–æ—á–∫–µ:</label>
            <select id="aiCount">
                <option value="1">1 –ë–æ—Ç (–ê–ª—å—Ñ–∞ ü§ñ)</option>
                <option value="2">2 –ë–æ—Ç–∞ (–ê–ª—å—Ñ–∞, –ë–µ—Ç–∞ ü¶æ)</option>
                <option value="3">3 –ë–æ—Ç–∞ (–ê–ª—å—Ñ–∞, –ë–µ—Ç–∞, –ì–∞–º–º–∞ ‚öôÔ∏è)</option>
            </select>
        </div>

        <div class="setup-row">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ö:</label>
            <select id="flyCount">
                <option value="1">1 –ú—É—Ö–∞</option>
                <option value="2">2 –ú—É—Ö–∏</option>
                <option value="3">3 –ú—É—Ö–∏</option>
            </select>
        </div>

        <button onclick="startGame()" class="btn btn-out" style="margin-top: 10px;">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ü–µ–ø–æ—á–∫—É</button>
    </div>

    <div id="game" class="card hidden">
        <div id="turnTag" class="turn-indicator">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <div class="status-box" id="status"></div>
        
        <button id="toggleGrid" style="background:none; border:1px solid #30363d; color:#8b949e; padding:5px 12px; border-radius:20px; cursor:pointer; font-size:10px; margin-bottom:10px;" onclick="toggleGrid()">üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ</button>

        <div class="grid-container"><div id="grid" class="grid"></div></div>
        
        <div class="controls" id="controls">
            <div></div><button class="btn btn-dir" onclick="handleMove('–≤–≤–µ—Ä—Ö')">‚Üë</button><div></div>
            <button class="btn btn-dir" onclick="handleMove('–≤–ª–µ–≤–æ')">‚Üê</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–Ω–∏–∑')">‚Üì</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–ø—Ä–∞–≤–æ')">‚Üí</button>
            <button class="btn btn-out" onclick="playerClaimOut()">–í–´–õ–ï–¢!</button>
        </div>
        <div id="log" class="history"></div>
        <button onclick="location.reload()" style="margin-top:10px; background:none; border:none; color:#555; cursor:pointer; font-size:12px">–í—ã—Ö–æ–¥ –≤ –º–µ–Ω—é</button>
    </div>
</div>

<script>
    const flyMeta = [
        { name: '–ö—Ä–∞—Å–Ω–∞—è –º—É—Ö–∞', icon: 'üî¥' }, { name: '–ó–µ–ª–µ–Ω–∞—è –º—É—Ö–∞', icon: 'üü¢' },
        { name: '–°–∏–Ω—è—è –º—É—Ö–∞', icon: 'üîµ' }, { name: '–ñ–µ–ª—Ç–∞—è –º—É—Ö–∞', icon: 'üü°' }, { name: '–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –º—É—Ö–∞', icon: 'üü£' }
    ];

    const aiBots = [
        { name: '–ò–ò –ê–ª—å—Ñ–∞', icon: 'ü§ñ' },
        { name: '–ò–ò –ë–µ—Ç–∞', icon: 'ü¶æ' },
        { name: '–ò–ò –ì–∞–º–º–∞', icon: '‚öôÔ∏è' }
    ];

    let cfg = { size: 3, flyCount: 1, aiCount: 1 };
    let flies = [];
    let turnChain = []; // –û—á–µ—Ä–µ–¥—å –∏–≥—Ä–æ–∫–æ–≤: ['user', 'ai0', 'ai1'...]
    let currentTurnIdx = 0;
    let activeFlyIdx = 0;
    let totalMoves = 0;
    let isGameOver = false;
    let aiTimer;

    const dirs = { '–≤–≤–µ—Ä—Ö': {x: 0, y: -1}, '–≤–Ω–∏–∑': {x: 0, y: 1}, '–≤–ª–µ–≤–æ': {x: -1, y: 0}, '–≤–ø—Ä–∞–≤–æ': {x: 1, y: 0} };
    const opposites = { '–≤–≤–µ—Ä—Ö': '–≤–Ω–∏–∑', '–≤–Ω–∏–∑': '–≤–≤–µ—Ä—Ö', '–≤–ª–µ–≤–æ': '–≤–ø—Ä–∞–≤–æ', '–≤–ø—Ä–∞–≤–æ': '–≤–ª–µ–≤–æ' };

    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'ru-RU'; window.speechSynthesis.speak(m); }
    function toggleGrid() { 
        const g = document.getElementById('grid'); g.classList.toggle('hidden-grid');
        document.getElementById('toggleGrid').innerText = g.classList.contains('hidden-grid') ? "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ" : "üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ";
    }

    function startGame() {
        cfg.size = 3; // –î–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ª—É—á—à–µ 3
        cfg.flyCount = parseInt(document.getElementById('flyCount').value);
        cfg.aiCount = parseInt(document.getElementById('aiCount').value);
        const colorStart = parseInt(document.getElementById('primaryColor').value);

        // –°–æ–∑–¥–∞–µ–º –º—É—Ö
        flies = [];
        for(let i=0; i<cfg.flyCount; i++) {
            let meta = flyMeta[(colorStart + i) % flyMeta.length];
            flies.push({ x: 1, y: 1, ...meta, out: false, last: null });
        }

        // –°–æ–∑–¥–∞–µ–º —Ü–µ–ø–æ—á–∫—É —Ö–æ–¥–æ–≤: –°–Ω–∞—á–∞–ª–∞ –¢—ã, –ø–æ—Ç–æ–º –≤—Å–µ –ò–ò
        turnChain = ['user'];
        for(let i=0; i<cfg.aiCount; i++) turnChain.push('ai' + i);

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        
        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(3, 1fr)`;
        for(let i=0; i<9; i++) g.innerHTML += `<div class="cell"></div>`;

        // –ü–ï–†–í–´–ô –•–û–î (–≤—Å–µ–≥–¥–∞ –ò–ò –ê–ª—å—Ñ–∞ –¥–ª—è –∑–∞—Ç—Ä–∞–≤–∫–∏)
        const f = flies[0];
        const d = Object.keys(dirs)[Math.floor(Math.random()*4)];
        const startMsg = `${f.name} –≤ —Ü–µ–Ω—Ç—Ä–µ ‚Äî ${f.name} ${d}`;
        
        updateStatus(`${f.icon} ${startMsg}`);
        speak(startMsg);
        moveLogic(f, d, aiBots[0].name, aiBots[0].icon);
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤ —Ü–µ–ø–æ—á–∫–µ (–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
        nextTurn();
    }

    function nextTurn() {
        if(isGameOver) return;
        currentTurnIdx = (currentTurnIdx + 1) % turnChain.length;
        const currentId = turnChain[currentTurnIdx];

        if(currentId === 'user') {
            document.getElementById('turnTag').innerText = "–¢–í–û–ô –•–û–î";
            toggleControls(true);
        } else {
            const aiIdx = parseInt(currentId.replace('ai', ''));
            document.getElementById('turnTag').innerText = `–•–û–î–ò–¢ ${aiBots[aiIdx].name}`;
            toggleControls(false);
            setTimeout(() => performAiMove(aiIdx), 1500);
        }
    }

    function handleMove(d) {
        if(isGameOver) return;
        let f = flies[activeFlyIdx];
        
        if(f.last && d === opposites[f.last]) {
            speak("–û—à–∏–±–∫–∞! –ù–∞–∑–∞–¥ –Ω–µ–ª—å–∑—è.");
            return endGame("–ü—Ä–æ–∏–≥—Ä—ã—à! –û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥ –∑–∞–ø—Ä–µ—â–µ–Ω.");
        }

        moveLogic(f, d, '–¢—ã', 'üë§');
        if(f.out) {
            aiTimer = setTimeout(() => endGame(`–ò–ò –ó–ê–ú–ï–¢–ò–õ! ${f.name} —É–ª–µ—Ç–µ–ª–∞ –Ω–∞ —Ç–≤–æ–µ–º —Ö–æ–¥—É.`), 3500);
        } else {
            activeFlyIdx = (activeFlyIdx + 1) % cfg.flyCount;
            totalMoves++;
            nextTurn();
        }
    }

    function performAiMove(botIdx) {
        if(isGameOver || flies.some(fl => fl.out)) return;
        let f = flies[activeFlyIdx];
        let bot = aiBots[botIdx];
        
        let keys = Object.keys(dirs).filter(k => k !== opposites[f.last]);
        let safe = keys.filter(k => { 
            let nx = f.x + dirs[k].x; let ny = f.y + dirs[k].y; 
            return nx >= 0 && nx < 3 && ny >= 0 && ny < 3; 
        });

        // –ß–µ–º –±–æ–ª—å—à–µ —Ö–æ–¥–æ–≤, —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å –≤—ã–ª–µ—Ç–∞ (–ø–æ—Å–ª–µ 5 —Ö–æ–¥–∞)
        let move = (totalMoves < 5 || Math.random() > 0.1) && safe.length > 0 ? 
                   safe[Math.floor(Math.random()*safe.length)] : 
                   keys[Math.floor(Math.random()*keys.length)];

        const msg = `${f.name} ${move}`;
        updateStatus(`${f.icon} ${msg.toUpperCase()}`);
        speak(msg);
        moveLogic(f, move, bot.name, bot.icon);

        if(f.out) {
            aiTimer = setTimeout(() => endGame(`–ò–ò –ü–û–ë–ï–î–ò–õ! –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≤—ã–ª–µ—Ç (${f.name})`), 4000);
        } else {
            activeFlyIdx = (activeFlyIdx + 1) % cfg.flyCount;
            totalMoves++;
            nextTurn();
        }
    }

    function moveLogic(f, d, playerName, playerIcon) {
        f.x += dirs[d].x; f.y += dirs[d].y; f.last = d;
        const entry = `<div class="log-item">${playerIcon} ${playerName}: ${f.icon} ${d}</div>`;
        document.getElementById('log').innerHTML = entry + document.getElementById('log').innerHTML;
        
        const sb = document.getElementById('status');
        sb.classList.remove('pulse'); void sb.offsetWidth; sb.classList.add('pulse');
        
        if(f.x < 0 || f.x >= 3 || f.y < 0 || f.y >= 3) f.out = true;
    }

    function playerClaimOut() {
        clearTimeout(aiTimer);
        if(flies.some(f => f.out)) endGame("–ü–û–ë–ï–î–ê! –¢—ã –æ—Ç—Å–ª–µ–¥–∏–ª –≤—Å—é —Ü–µ–ø–æ—á–∫—É.");
        else endGame("–û–®–ò–ë–ö–ê! –ú—É—Ö–∞ –≤—Å–µ –µ—â–µ –≤ –ø–æ–ª–µ.");
    }

    function toggleControls(on) {
        const btns = document.querySelectorAll('.btn-dir');
        btns.forEach(b => b.disabled = !on);
    }

    function updateStatus(t) { document.getElementById('status').innerText = t; }
    function endGame(m) { isGameOver = true; alert(m); location.reload(); }
</script>
</body>
</html>
