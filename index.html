<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É—Ö–∞ PRO: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        :root { --bg: #0b0e14; --panel: #161b22; --primary: #7928ca; --accent: #ff0080; --succ: #00dfd8; --text: #e6edf3; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0b0e14; color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 420px; padding: 20px; box-sizing: border-box; }
        
        .card { background: var(--panel); border-radius: 24px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #30363d; text-align: center; position: relative; width: 100%; box-sizing: border-box; }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–æ–º–æ—â—å */
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .help-btn { background: #30363d; border: none; color: var(--primary); width: 32px; height: 32px; border-radius: 50%; font-weight: bold; cursor: pointer; font-size: 18px; }
        
        /* –°–µ—Ç–∫–∞ –ø–æ–ª—è */
        .grid-container { min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .grid { display: grid; gap: 8px; background: #30363d; padding: 10px; border-radius: 16px; transition: 0.3s; }
        .grid.hidden-grid { opacity: 0; transform: scale(0.95); }
        .cell { width: 50px; height: 50px; background: #0d1117; border-radius: 8px; border: 1px solid #21262d; }

        /* –°—Ç–∞—Ç—É—Å –∏ —Ñ—Ä–∞–∑—ã */
        .status-box { height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; line-height: 1.4; margin-bottom: 10px; color: #fff; }
        
        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .btn { border: none; border-radius: 16px; cursor: pointer; color: white; transition: 0.1s; font-weight: bold; }
        .btn-dir { background: #21262d; border: 1px solid #30363d; height: 60px; font-size: 1.5rem; }
        .btn-dir:active { background: var(--primary); transform: translateY(2px); }
        
        .btn-out { grid-column: span 3; background: linear-gradient(90deg, var(--accent), var(--primary)); padding: 20px; font-size: 1.2rem; border-radius: 18px; box-shadow: 0 4px 15px rgba(255,0,128,0.3); text-transform: uppercase; }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .setup-row { margin-bottom: 15px; text-align: left; }
        label { font-size: 14px; color: #8b949e; display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 12px; border-radius: 10px; background: #0d1117; color: white; border: 1px solid #30363d; font-size: 16px; box-sizing: border-box; }
        
        .history { background: #000; padding: 12px; border-radius: 12px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #8b949e; text-align: left; border: 1px solid #21262d; }
        
        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: var(--panel); padding: 25px; border-radius: 24px; border: 1px solid var(--primary); max-width: 400px; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <div class="header-area">
            <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="help-btn" onclick="toggleModal(true)">?</button>
        </div>
        
        <div class="setup-row">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ö:</label>
            <select id="flyCount">
                <option value="1">1 –ú—É—Ö–∞ üî¥</option>
                <option value="2">2 –ú—É—Ö–∏ üî¥ üü¢</option>
                <option value="3">3 –ú—É—Ö–∏ üî¥ üü¢ üü°</option>
            </select>
        </div>
        
        <div class="setup-row">
            <label>–†–∞–∑–º–µ—Ä –ø–æ–ª—è:</label>
            <input type="number" id="size" value="3" min="3" max="5">
        </div>

        <div class="setup-row">
            <label>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–ª–µ—Ç–∞:</label>
            <select id="diff">
                <option value="0.04">–ù–∏–∑–∫–∞—è (–¥–ª–∏–Ω–Ω–∞—è –∏–≥—Ä–∞)</option>
                <option value="0.1" selected>–°—Ä–µ–¥–Ω—è—è (–Ω–æ—Ä–º–∞)</option>
                <option value="0.25">–í—ã—Å–æ–∫–∞—è (–æ–ø–∞—Å–Ω–æ)</option>
            </select>
        </div>

        <button onclick="startGame()" class="btn btn-out" style="margin-top: 10px;">–í–∑–ª–µ—Ç–∞–µ–º!</button>
    </div>

    <div id="game" class="card hidden">
        <button class="help-btn" style="position:absolute; top:15px; right:15px" onclick="toggleModal(true)">?</button>
        <button id="toggleGrid" style="background:none; border:1px solid #30363d; color:#8b949e; padding:5px 15px; border-radius:20px; cursor:pointer; font-size:12px; margin-bottom:10px;" onclick="toggleGrid()">üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ</button>
        
        <div class="status-box" id="status"></div>
        
        <div class="grid-container">
            <div id="grid" class="grid"></div>
        </div>
        
        <div class="controls">
            <div></div><button class="btn btn-dir" onclick="handleMove('–≤–≤–µ—Ä—Ö')">‚Üë</button><div></div>
            <button class="btn btn-dir" onclick="handleMove('–≤–ª–µ–≤–æ')">‚Üê</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–Ω–∏–∑')">‚Üì</button>
            <button class="btn btn-dir" onclick="handleMove('–≤–ø—Ä–∞–≤–æ')">‚Üí</button>
            <button class="btn btn-out" onclick="playerClaimOut()">–ú—É—Ö–∞ –≤—ã–ª–µ—Ç–µ–ª–∞!</button>
        </div>
        
        <div id="log" class="history"></div>
        <button onclick="location.reload()" style="margin-top:15px; background:none; border:none; color:#555; cursor:pointer;">–í –º–µ–Ω—é</button>
    </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--primary); margin-top:0">–ö–∞–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è:</h3>
        <ul style="text-align:left; font-size:14px; padding-left:20px">
            <li>–î–µ—Ä–∂–∏—Ç–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –º—É—Ö –≤ —É–º–µ.</li>
            <li><b>–û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥ –∑–∞–ø—Ä–µ—â–µ–Ω:</b> –Ω–µ–ª—å–∑—è —Å—Ö–æ–¥–∏—Ç—å –í–ª–µ–≤–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –í–ø—Ä–∞–≤–æ.</li>
            <li>–ü–µ—Ä–≤—ã–µ 5 —Ö–æ–¥–æ–≤ –ò–ò –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç –º—É—Ö.</li>
            <li>–ï—Å–ª–∏ –º—É—Ö–∞ —É—à–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É ‚Äî –∂–º–∏ –∫—Ä–∞—Å–Ω—É—é –∫–Ω–æ–ø–∫—É!</li>
        </ul>
        <button class="btn btn-out" style="padding:10px; width:100%" onclick="toggleModal(false)">–ü–æ–Ω—è–ª</button>
    </div>
</div>

<script>
    let cfg = { size: 3, count: 1, diff: 0.1 };
    let flies = [];
    let activeFlyIdx = 0;
    let turnCounter = 0;
    let gameOver = false;
    let aiWait;

    const dirs = { '–≤–≤–µ—Ä—Ö': {x: 0, y: -1}, '–≤–Ω–∏–∑': {x: 0, y: 1}, '–≤–ª–µ–≤–æ': {x: -1, y: 0}, '–≤–ø—Ä–∞–≤–æ': {x: 1, y: 0} };
    const opposites = { '–≤–≤–µ—Ä—Ö': '–≤–Ω–∏–∑', '–≤–Ω–∏–∑': '–≤–≤–µ—Ä—Ö', '–≤–ª–µ–≤–æ': '–≤–ø—Ä–∞–≤–æ', '–≤–ø—Ä–∞–≤–æ': '–≤–ª–µ–≤–æ' };
    const flyMeta = [
        { name: '–ö—Ä–∞—Å–Ω–∞—è –º—É—Ö–∞', icon: 'üî¥' },
        { name: '–ó–µ–ª–µ–Ω–∞—è –º—É—Ö–∞', icon: 'üü¢' },
        { name: '–ñ–µ–ª—Ç–∞—è –º—É—Ö–∞', icon: 'üü°' }
    ];

    function toggleModal(s) { document.getElementById('helpModal').style.display = s ? 'flex' : 'none'; }
    function toggleGrid() {
        const g = document.getElementById('grid');
        g.classList.toggle('hidden-grid');
        document.getElementById('toggleGrid').innerText = g.classList.contains('hidden-grid') ? "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ" : "üëÅ –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ";
    }

    function speak(t) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t);
        m.lang = 'ru-RU';
        window.speechSynthesis.speak(m);
    }

    function startGame() {
        cfg.size = parseInt(document.getElementById('size').value);
        cfg.count = parseInt(document.getElementById('flyCount').value);
        cfg.diff = parseFloat(document.getElementById('diff').value);
        
        flies = [];
        for(let i=0; i<cfg.count; i++) {
            flies.push({ 
                x: Math.floor(cfg.size/2), 
                y: Math.floor(cfg.size/2), 
                name: flyMeta[i].name, 
                icon: flyMeta[i].icon, 
                out: false, 
                last: null 
            });
        }

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        
        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(${cfg.size}, 1fr)`;
        g.innerHTML = '';
        for(let i=0; i<cfg.size*cfg.size; i++) g.innerHTML += `<div class="cell"></div>`;

        // –ü–ï–†–í–´–ô –•–û–î
        const f = flies[0];
        const d = Object.keys(dirs)[Math.floor(Math.random()*4)];
        const phrase = `${f.name} –≤ —Ü–µ–Ω—Ç—Ä–µ ‚Äî ${f.name} ${d}`;
        
        updateStatus(`${f.icon} ${phrase}`);
        speak(phrase);
        moveLogic(f, d, '–ò–ò');
    }

    function handleMove(d) {
        if(gameOver) return;
        let f = flies[activeFlyIdx];
        
        if(f.last && d === opposites[f.last]) {
            speak("–û—à–∏–±–∫–∞! –û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥.");
            return endGame("–ü—Ä–æ–∏–≥—Ä—ã—à! –ù–∞–∑–∞–¥ —Ö–æ–¥–∏—Ç—å –Ω–µ–ª—å–∑—è.");
        }

        updateStatus(`${f.icon} –¢–≤–æ–π —Ö–æ–¥: ${d.toUpperCase()}`);
        moveLogic(f, d, '–¢—ã');
        
        if(f.out) {
            aiWait = setTimeout(() => endGame(`–ò–ò –ó–ê–ú–ï–¢–ò–õ! ${f.name} —É–ª–µ—Ç–µ–ª–∞.`), 3500);
        } else {
            activeFlyIdx = (activeFlyIdx + 1) % cfg.count;
            turnCounter++;
            setTimeout(aiMove, 1200);
        }
    }

    function aiMove() {
        if(gameOver || flies.some(fl => fl.out)) return;
        let f = flies[activeFlyIdx];
        
        let keys = Object.keys(dirs).filter(k => k !== opposites[f.last]);
        let safe = keys.filter(k => {
            let nx = f.x + dirs[k].x; let ny = f.y + dirs[k].y;
            return nx >= 0 && nx < cfg.size && ny >= 0 && ny < cfg.size;
        });

        // –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç: –∑–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–ª–µ—Ç–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∏ –ø–æ —à–∞–Ω—Å—É
        let move = (turnCounter < 5 || Math.random() > cfg.diff) && safe.length > 0 ? 
                   safe[Math.floor(Math.random()*safe.length)] : 
                   keys[Math.floor(Math.random()*keys.length)];

        const phrase = `${f.name} ${move}`;
        updateStatus(`${f.icon} ${phrase.toUpperCase()}`);
        speak(phrase);
        moveLogic(f, move, '–ò–ò');
        
        if(f.out) {
            aiWait = setTimeout(() => endGame(`–ò–ò –ü–û–ë–ï–î–ò–õ! –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≤—ã–ª–µ—Ç –º—É—Ö–∏ ${f.name}`), 4000);
        } else {
            activeFlyIdx = (activeFlyIdx + 1) % cfg.count;
            turnCounter++;
        }
    }

    function moveLogic(f, d, p) {
        f.x += dirs[d].x; f.y += dirs[d].y; f.last = d;
        const entry = `<div>${f.icon} ${p}: ${d}</div>`;
        document.getElementById('log').innerHTML = entry + document.getElementById('log').innerHTML;
        if(f.x < 0 || f.x >= cfg.size || f.y < 0 || f.y >= cfg.size) f.out = true;
    }

    function playerClaimOut() {
        clearTimeout(aiWait);
        if(flies.some(f => f.out)) endGame("–ü–û–ë–ï–î–ê! –¢—ã –≤–æ–≤—Ä–µ–º—è –∑–∞–º–µ—Ç–∏–ª –≤—ã–ª–µ—Ç.");
        else endGame("–û–®–ò–ë–ö–ê! –ú—É—Ö–∞ –≤—Å–µ –µ—â–µ –Ω–∞ –ø–æ–ª–µ.");
    }

    function updateStatus(t) { document.getElementById('status').innerText = t; }
    function endGame(m) { gameOver = true; alert(m); location.reload(); }
</script>
</body>
</html>
